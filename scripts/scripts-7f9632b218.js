"use strict";angular.module("chatappApp",["ngAnimate","ngCookies","ngMessages","ngRoute","ngSanitize"]).config(["$routeProvider",function(e){e.when("/main",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/",{templateUrl:"views/login.html",controller:"loginCtrl",controllerAs:"login"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).otherwise({redirectTo:"/"})}]).directive("contenteditable",["$sce",function(e){return{restrict:"A",require:"?ngModel",link:function(t,n,r,s){function a(){var e=n.html();r.stripBr&&"<br>"==e&&(e=""),e=e.replace("<br>",""),s.$setViewValue(e)}s&&(s.$render=function(){n.html(e.getTrustedHtml(s.$viewValue||"")),a()},n.on("blur keyup change",function(){t.$evalAsync(a)}))}}}]);var User=function(e,t,n){this.username=e,this.id=n,this.isOnline=t},Conversation=function(e,t,n,r,s){this.convId=e,this.participants=t,this.isUnread=n,this.lastTimeStamp=r,this.name=s},Message=function(e,t,n,r,s){this.msgId=e,this.convId=t,this.sender=n,this.timeStamp=r,this.text=s};angular.module("chatappApp").factory("usersStorage",function(){var e="users",t="lastUID",n={lastId:0,users:[],saveStorage:function(){localStorage.setItem(e,angular.toJson(n.users)),localStorage.setItem(t,angular.toJson(n.lastId))},get:function(){return n.users=JSON.parse(localStorage.getItem(e)||"[]"),n.lastId=JSON.parse(localStorage.getItem(t)||0),n.users},insert:function(e,t){var r=new User(e,t,(++n.lastId));return n.users.push(r),n.saveStorage(),r},update:function(e){var t=n.users.findIndex(function(t){return t.id==e.id});return t==-1?-1:(n.users[t]=e,void n.saveStorage())}};return n}).factory("loggedInUser",function(){var e={user:null,set:function(t){e.user=t},get:function(){return e.user}};return e}).factory("conversationsStorage",function(){var e="conversations",t="lastCID",n={conversations:[],lastId:0,saveStorage:function(){localStorage.setItem(e,angular.toJson(n.conversations)),localStorage.setItem(t,angular.toJson(n.lastId))},get:function(){return n.conversations=JSON.parse(localStorage.getItem(e)||"[]"),n.lastId=JSON.parse(localStorage.getItem(t)||0),n.conversations},insert:function(e,t,r,s){var a=new Conversation((++n.lastId),e,t,r,s);return n.conversations.push(a),n.saveStorage(),a},update:function(e){var t=n.conversations.findIndex(function(t){return t.convId==e.convId});return t==-1?-1:(n.conversations[t]=e,void n.saveStorage())}};return n}).factory("messagessStorage",function(){var e="messages",t="lastMID",n={messages:[],lastId:0,saveStorage:function(){localStorage.setItem(e,angular.toJson(n.messages)),localStorage.setItem(t,angular.toJson(n.lastId))},get:function(){return n.messages=JSON.parse(localStorage.getItem(e)||"[]"),n.lastId=JSON.parse(localStorage.getItem(t)||0),n.messages},insert:function(e,t,r,s){var a=new Message((++n.lastId),e,t,r,s);return n.messages.push(a),n.saveStorage(),a}};return n}).factory("currentCoversation",function(){var e={c:null,set:function(t){e.c=t},get:function(){return e.c}};return e}),angular.module("chatappApp").factory("imgurUpload",["$http",function(e){var t="6930816ec9608e5",n="https://api.imgur.com/3/image",r="http://i.imgur.com/eQlhK72.png",s={uploadImage:function(r){var s={method:"POST",url:n,headers:{Authorization:"Client-ID "+t},data:r};return e(s)},getFakeUrl:function(){return r}};return s}]),angular.module("chatappApp").factory("backend",["$rootScope","conversationsStorage","loggedInUser","messagessStorage","usersStorage","imgurUpload","currentCoversation",function(e,t,n,r,s,a,o){var i=t.get(),l=r.get(),u=s.get(),g={updateValues:function(){i=t.get(),l=r.get(),u=s.get()},getAvailableUsers:function(){return u},getCurrentConv:function(){return o.get()},getConversations:function(){if(void 0==n.get())return[];for(var e=[],t=0;t<i.length;t++)i[t].participants.indexOf(n.get().id)!=-1&&e.push(i[t]);return e},getMessages:function(){for(var e=g.getConversations(),t=[],n=0;n<e.length;n++)t.push(e[n].convId);for(var r=[],n=0;n<l.length;n++)t.indexOf(l[n].convId)!=-1&&""!=l[n].text&&r.push(l[n]);return r},updateConversation:function(e){t.update(e)},uploadImage:function(e){var t=a.uploadImage(e);return t},addNewChat:function(e,s,a,u){for(var c=new Date,d=null,v=s,f=[n.get().username],m=[n.get().id],p=[!1],h=0;h<v.length;h++)f.push(v[h].username),m.push(v[h].id),v[h].id==n.get().id?p.push(!1):p.push(!0);for(var U=m.sort().toString(),h=0;h<i.length;h++)if(U==i[h].participants.sort().toString()){e=!1,o.set(i[h]);break}u=g.getMessages(),e?(d=t.insert(m,p,c,f),o.set(d),u=[]):d=o.get();for(var h=0;h<d.isUnread.length;h++)n.get().id==d.participants[h]?d.isUnread[h]=!1:d.isUnread[h]=!0;d.lastTimeStamp=c;var I=r.insert(d.convId,n.get().id,c,a);return t.update(d),i=t.get(),l=r.get(),u.push(I),console.log("message sent"),u},unload:function(){i=null,l=null,u=null,o.set(null);var e=n.get();e.isOnline=!1,n.set(null),s.update(e)},load:function(){i=t.get(),l=r.get(),u=s.get()}};return g}]),angular.module("chatappApp").controller("MainCtrl",["$rootScope","$scope","conversationsStorage","$window","loggedInUser","messagessStorage","usersStorage","imgurUpload","backend","currentCoversation",function(e,t,n,r,s,a,o,i,l,u){var g=this;g.currentUser=s.get(),g.currentConv=u.get(),g.userMessages=l.getMessages(),g.filteredMsgs=[],g.message={text:"",type:1},g.usersToAdd=[],g.availableUsers=l.getAvailableUsers(),g.conversations=l.getConversations(),g.emojifyConfig={mode:"img",img_dir:"images/basic/"},emojify.setConfig(g.emojifyConfig),emojify.run(),g.emojisString=[":)",":(",":O",":/"],g.emojis=[];for(var c=0;c<g.emojisString.length;c++)g.emojis.push({emoji:emojify.replace(g.emojisString[c]),id:"emoji"+c});angular.element("[data-toggle='tooltip']").tooltip(),angular.element("#conversationLogo").hide(),g.addNewChat=function(e){2!=g.message.type&&(g.message.text=emojify.replace(g.textMessage)),l.addNewChat(e,g.usersToAdd,g.message,g.filteredMsgs),g.currentConv=l.getCurrentConv(),g.userMessages=l.getMessages(),g.conversations=l.getConversations(),g.message={text:"",type:1},g.message.text="",g.textMessage="";for(var t=0;t<g.availableUsers.length;t++)angular.element("#user"+t).prop("checked")&&angular.element("#user"+t).prop("checked",!1);for(var n=[],t=0;t<g.getUserMessages().length;t++)g.currentConv.convId==g.getUserMessages()[t].convId&&n.push(g.getUserMessages()[t]);g.filteredMsgs=n},g.showAddParticipant=function(){angular.element("#tempMsg").modal()},g.addParticipants=function(){for(var e=[],t=0;t<g.availableUsers.length;t++)angular.element("#user"+t).prop("checked")&&e.push(g.availableUsers[t]);g.usersToAdd=e,g.addNewChat(!0),angular.element("#tempMsg").modal("hide")},g.setAvailableUsers=function(){return g.availableUsers=l.getAvailableUsers(),g.availableUsers},g.getAvailableUsers=function(){return g.availableUsers},g.setConversations=function(){g.conversations=l.getConversations()},g.getConversations=function(){return g.conversations},g.setUserMessages=function(){g.userMessages=l.getMessages()},g.getUserMessages=function(){return g.userMessages},g.showSenderName=function(){return null!=g.currentConv&&2==g.currentConv.participants.length},g.getSenderName=function(e){for(var t=0;t<g.getAvailableUsers().length;t++)if(e==g.getAvailableUsers()[t].id)return g.getAvailableUsers()[t].username},g.getLastMessage=function(e){if(null==g.currentUser)return null;for(var t=new Date(0),n=null,r=-1,s=0;s<g.getUserMessages().length;s++){var a=new Date(g.getUserMessages()[s].timeStamp);g.getUserMessages()[s].convId==e&&a>t&&""!=g.getUserMessages()[s].text&&(t=a,r=s)}return r==-1?null:(n=angular.copy(g.getUserMessages()[r].text),2===n.type&&(n.text="<div class='textIcon'></div>"),n.text)},g.isUnread=function(e){if(void 0==g.currentUser)return!0;var t=null,n=g.getConversations().findIndex(function(t){return t.convId==e}),r=g.getConversations()[n].participants.findIndex(function(e){return e==g.currentUser.id});return t=g.getConversations()[n].isUnread[r]},t.convClicked=function(e){for(var t=null,n=0;n<g.getConversations().length;n++)if(e.currentTarget.id==g.getConversations()[n].convId){t=g.getConversations()[n];break}if(null==t)return null;for(var r=[],n=0;n<g.getUserMessages().length;n++)e.currentTarget.id==g.getUserMessages()[n].convId&&r.push(g.getUserMessages()[n]);g.filteredMsgs=r;for(var n=0;n<t.isUnread.length;n++)g.currentUser.id==t.participants[n]&&(t.isUnread[n]=!1);l.updateConversation(t),u.set(t),g.currentConv=t,angular.element("#conversationLogo").show()},g.uploadImage=function(){angular.element("#fileDialog").click()},t.sendMsgAsImage=function(e){console.log(e.files[0]);var t=l.uploadImage(e.files[0]),n="";t.then(function(e){n=e.data.data.link,g.message={text:"<img src='"+n+"' class='img-thumbnail'>",type:2},g.addNewChat(!1)},function(e){n="error"})},g.getName=function(e){if(null==g.currentUser)return"";if(null==e||void 0==e)return"";for(var t=[],n=0;n<e.name.length;n++)e.name[n]!=g.currentUser.username&&t.push(e.name[n]);return t.toString()},g.isEnter=function(e){13==e.keyCode&&g.addNewChat(!1)},t.emoClicked=function(e){var t=angular.element("#"+e.currentTarget.id).html();g.textMessage+=t},g.openEmojis=function(){angular.element("#emojisDiv").toggle()},g.clearPlaceholder=function(e){"mouseover"==e.type?angular.element("#inputPlaceHolder").text(""):"mouseleave"==e.type&&""==g.textMessage&&angular.element("#inputPlaceHolder").text("Type a message")},angular.element("#inputTextMessage").keyup(function(e){g.check_charcount("inputTextMessage",100,e)}),angular.element("#inputTextMessage").keydown(function(e){g.check_charcount("inputTextMessage",100,e)}),g.check_charcount=function(e,t,n){8!=n.which&&angular.element("#"+e).text().length>t&&n.preventDefault()},angular.element(r).on("storage",function(t){if(console.log("called"),l.updateValues(),null!=g.currentUser)if("lastMID"==t.originalEvent.key){g.setConversations(),g.setUserMessages(),console.log(g.currentUser);var n=[];if(null!=g.currentConv)for(var r=0;r<g.getUserMessages().length;r++)g.currentConv.convId==g.getUserMessages()[r].convId&&n.push(g.getUserMessages()[r]);g.filteredMsgs=n,e.$apply()}else"lastUID"==t.originalEvent.key&&g.setAvailableUsers()}),r.onbeforeunload=function(){null!=g.currentUser&&(console.log(g.currentUser),g.currentUser.isOnline=!1,o.update(g.currentUser),g.currentConv=null,l.unload(),console.log("signed out"),e.$apply())},t.getScope=function(){return t}}]),angular.module("chatappApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("chatappApp").controller("loginCtrl",["$scope","usersStorage","$window","loggedInUser","$location","backend",function(e,t,n,r,s,a){var o=this;o.userName="",o.currentUser=r.get(),o.signIn=function(){if(""==o.userName)return void angular.element("#alert").show();null!=o.currentUser&&o.currentUser.isOnline&&a.unload();var e=t.get(),n=e.find(function(e){return e.username==o.userName});return void 0==n?(o.currentUser=t.insert(o.userName,!0),r.set(o.currentUser),console.log("created new user"),angular.element("#newUserCreated").show(),a.load(),void setTimeout(2e3,s.path("/main"))):(n.isOnline&&console.log("already online"),n.isOnline=!0,o.currentUser=n,t.update(n),r.set(o.currentUser),console.log("successfully signed in"),a.load(),void s.path("/main"))}}]);